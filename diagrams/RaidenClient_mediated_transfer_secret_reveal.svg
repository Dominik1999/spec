<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="1565" height="1089" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[participant Initiator
participant Mediator1
participant Mediator2
participant Target
participant SecretRegistryContract

Initiator -> Mediator1: LockedTransfer(MSG) \n (HTL, BP, initiator_address,\n target_address)
Mediator1 -> Mediator2: LockedTransfer(MSG) \n (HTL, BP, initiator_address,\n target_address)
Mediator2 -> Target: LockedTransfer(MSG) \n (HTL, BP, initiator_address,\n target_address)
Target -> Initiator: SecretRequest(MSG) \n (amount, secrethash,\n signature)
Initiator -> Target: RevealSecret(MSG) \n (secret, signature)
Target -> Mediator2: RevealSecret(MSG) \n (secret, signature)

Note over Mediator2, Target: Bad behaviour \n M2 does not send the BP to Target


Note over Target: waits until lock \n is about to expire
Note over Target: CHOICE \n lose the transfer \n or go ON CHAIN
Target -> SecretRegistryContract: registerSecret(secret)
Note over Mediator1, Target: Secret can be used by all nodes to UNLOCK the transfer after settling the channels \n SecretRegistry.getSecretRevealBlockHeight(secrethash)
Mediator2 --> Mediator1: RevealSecret(MSG) \n (secret, signature)
Mediator1 --> Mediator2: Unlock(MSG) BP_M1
Mediator1 --> Initiator: RevealSecret(MSG) \n (secret, signature)
Initiator --> Mediator1: Unlock(MSG) BP_I
]]></source><desc></desc><defs><marker viewBox="0 0 5 5" markerWidth="5" markerHeight="5" orient="auto" refX="5" refY="2.5" id="markerArrowBlock"><path d="M 0 0 L 5 2.5 L 0 5 z"></path></marker><marker viewBox="0 0 9.6 16" markerWidth="4" markerHeight="16" orient="auto" refX="9.6" refY="8" id="markerArrowOpen"><path d="M 9.6,8 1.92,16 0,13.7 5.76,8 0,2.286 1.92,0 9.6,8 z"></path></marker></defs><g class="title"></g><g class="actor"><rect x="10" y="20" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="20" y="45" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="20">Initiator</tspan></text></g><g class="actor"><rect x="10" y="1030.4000129699707" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="20" y="1055.4000129699707" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="20">Initiator</tspan></text></g><line x1="65" x2="65" y1="59" y2="1030.4000129699707" style="stroke-width: 2px;" stroke="#000000" fill="none"></line><g class="actor"><rect x="310" y="20" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="320" y="45" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="320">Mediator1</tspan></text></g><g class="actor"><rect x="310" y="1030.4000129699707" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="320" y="1055.4000129699707" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="320">Mediator1</tspan></text></g><line x1="365" x2="365" y1="59" y2="1030.4000129699707" style="stroke-width: 2px;" stroke="#000000" fill="none"></line><g class="actor"><rect x="610" y="20" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="620" y="45" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="620">Mediator2</tspan></text></g><g class="actor"><rect x="610" y="1030.4000129699707" width="110" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="620" y="1055.4000129699707" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="620">Mediator2</tspan></text></g><line x1="665" x2="665" y1="59" y2="1030.4000129699707" style="stroke-width: 2px;" stroke="#000000" fill="none"></line><g class="actor"><rect x="1135" y="20" width="80" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="1145" y="45" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="1145">Target</tspan></text></g><g class="actor"><rect x="1135" y="1030.4000129699707" width="80" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="1145" y="1055.4000129699707" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="1145">Target</tspan></text></g><line x1="1175" x2="1175" y1="59" y2="1030.4000129699707" style="stroke-width: 2px;" stroke="#000000" fill="none"></line><g class="actor"><rect x="1295" y="20" width="240" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="1305" y="45" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="1305">SecretRegistryContract</tspan></text></g><g class="actor"><rect x="1295" y="1030.4000129699707" width="240" height="39" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="1305" y="1055.4000129699707" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="1305">SecretRegistryContract</tspan></text></g><line x1="1415" x2="1415" y1="59" y2="1030.4000129699707" style="stroke-width: 2px;" stroke="#000000" fill="none"></line><g class="signal"><text x="75" y="70.29999923706055" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="75">LockedTransfer(MSG)</tspan><tspan dy="1.2em" x="75">(HTL, BP, initiator_address,</tspan><tspan dy="1.2em" x="75">target_address)</tspan></text><line x1="65" x2="365" y1="136.4000015258789" y2="136.4000015258789" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="375" y="147.70000076293945" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="375">LockedTransfer(MSG)</tspan><tspan dy="1.2em" x="375">(HTL, BP, initiator_address,</tspan><tspan dy="1.2em" x="375">target_address)</tspan></text><line x1="365" x2="665" y1="213.8000030517578" y2="213.8000030517578" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="780" y="225.10000228881836" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="780">LockedTransfer(MSG)</tspan><tspan dy="1.2em" x="780">(HTL, BP, initiator_address,</tspan><tspan dy="1.2em" x="780">target_address)</tspan></text><line x1="665" x2="1175" y1="291.2000045776367" y2="291.2000045776367" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="520" y="302.50000381469727" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="520">SecretRequest(MSG)</tspan><tspan dy="1.2em" x="520">(amount, secrethash,</tspan><tspan dy="1.2em" x="520">signature)</tspan></text><line x1="1175" x2="65" y1="368.6000061035156" y2="368.6000061035156" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="525" y="389.5000057220459" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="525">RevealSecret(MSG)</tspan><tspan dy="1.2em" x="525">(secret, signature)</tspan></text><line x1="65" x2="1175" y1="426.8000068664551" y2="426.8000068664551" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="825" y="447.70000648498535" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="825">RevealSecret(MSG)</tspan><tspan dy="1.2em" x="825">(secret, signature)</tspan></text><line x1="1175" x2="665" y1="485.00000762939453" y2="485.00000762939453" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="note"><rect x="655" y="505.00000762939453" width="530" height="48.20000076293945" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="660" y="525.0000076293945" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="660">Bad behaviour</tspan><tspan dy="1.2em" x="660">M2 does not send the BP to Target</tspan></text></g><g class="note"><rect x="1080" y="573.200008392334" width="190" height="48.20000076293945" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="1085" y="593.200008392334" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="1085">waits until lock</tspan><tspan dy="1.2em" x="1085">is about to expire</tspan></text></g><g class="note"><rect x="1085" y="641.4000091552734" width="180" height="67.4000015258789" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="1090" y="661.4000091552734" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="1090">CHOICE</tspan><tspan dy="1.2em" x="1090">lose the transfer</tspan><tspan dy="1.2em" x="1090">or go ON CHAIN</tspan></text></g><g class="signal"><text x="1185" y="739.3000106811523" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="1185">registerSecret(secret)</tspan></text><line x1="1175" x2="1415" y1="747.8000106811523" y2="747.8000106811523" style="stroke-width: 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="note"><rect x="355" y="767.8000106811523" width="830" height="48.20000076293945" style="stroke-width: 2px;" stroke="#000000" fill="#ffffff"></rect><text x="360" y="787.8000106811523" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="360">Secret can be used by all nodes to UNLOCK the transfer after settling the channels</tspan><tspan dy="1.2em" x="360">SecretRegistry.getSecretRevealBlockHeight(secrethash)</tspan></text></g><g class="signal"><text x="420" y="836.9000110626221" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="420">RevealSecret(MSG)</tspan><tspan dy="1.2em" x="420">(secret, signature)</tspan></text><line x1="665" x2="365" y1="874.2000122070312" y2="874.2000122070312" style="stroke-width: 2px; stroke-dasharray: 6px, 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="430" y="904.7000122070312" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="430">Unlock(MSG) BP_M1</tspan></text><line x1="365" x2="665" y1="913.2000122070312" y2="913.2000122070312" style="stroke-width: 2px; stroke-dasharray: 6px, 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="120" y="934.1000118255615" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="120">RevealSecret(MSG)</tspan><tspan dy="1.2em" x="120">(secret, signature)</tspan></text><line x1="365" x2="65" y1="971.4000129699707" y2="971.4000129699707" style="stroke-width: 2px; stroke-dasharray: 6px, 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g><g class="signal"><text x="135" y="1001.9000129699707" style="font-size: 16px; font-family: Andale Mono, monospace;"><tspan x="135">Unlock(MSG) BP_I</tspan></text><line x1="65" x2="365" y1="1010.4000129699707" y2="1010.4000129699707" style="stroke-width: 2px; stroke-dasharray: 6px, 2px; marker-end: url(&quot;#markerArrowBlock&quot;);" stroke="#000000" fill="none"></line></g></svg>